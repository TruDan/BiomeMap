<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>BiomeMap</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
          integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
          crossorigin="" />
    <style>
        #map {
            background-color: #000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
            integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
            crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
        integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
        crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"></script>
    <script type="text/javascript">
        var val={
            item: Math.random(),
            toString: function(){
                return this.item;
            }
        };

        var map = L.map('map',
            {
                center: new L.LatLng(0, 0),
                crs: L.extend({},
                    L.CRS.Simple,
                    {
                        code: 'simple',
                        projection: {
                            project: function (latlng) {
                                // Direct translation of lat -> x, lng -> y.
                                return new L.Point(latlng.lat, latlng.lng);
                            },
                            unproject: function (point) {
                                // Direct translation of x -> lat, y -> lng.
                                return new L.LatLng(point.x, point.y);
                            }
                        },
                        // a = 1; b = 2; c = 1; d = 0
                        // x = a * x + b; y = c * y + d
                        // End result is 1:1 values during transformation.
                        transformation: new L.Transformation(1, 0, 1, 0),
                        scale: function (zoom) {
                            // Equivalent to 2 raised to the power of zoom, but faster.
                            return (1 << zoom);
                        }
                    }),
                continuousWorld: true,
                worldCopyJump: false,
               // maxBounds: bounds,
                attributionControl: false,
                zoomAnimation: true,
                zoomControl: true,
                zoomReverse: true
            }).setView([0, 0], -3);

        /*var southWest = L.latLng(-1024, -1024),
            northEast = L.latLng(1024, 1024),
            bounds = L.latLngBounds(southWest, northEast);
        */
        var layer = L.tileLayer('http://' + window.location.host + '/tile/{y}/{x}/{z}.png?{test}', {
           // bounds: bounds,
            continuousWorld: true,
            noWrap: false,
            maxZoom: 9,
            minZoom: -18,
            maxNativeZoom: 0,
            minNativeZoom: 0,
            tileSize: 512,
            test: val
        }).addTo(map);

        var players = {};


        var socket = new ReconnectingWebSocket("ws://" + window.location.host + "/");
        socket.onmessage = function(e) {
            console.log(e);
            if (e.data === "reload") {
                layer.redraw();
            } else {
                var c = e.data.split(':');
                console.log(c, players);
                if (c[0] === "player") {
                    if (c[1] === "join") {
                        var pos = c[3].split(",");
                        var id = c[2];

                        if (id in players) {
                            return;
                        }

                        var player = players[id] = L.marker([parseInt(pos[0]), parseInt(pos[1])],
                            {
                                icon: L.icon({
                                    iconUrl: "/head/" + id + ".png",

                                    iconSize: [32, 32],
                                    shadowSize: [0, 0],
                                    iconAnchor: [0, 0],
                                    shadowAnchor: [0, 0],
                                    popupAnchor: [0, 0]
                                }),
                                title: c[4]
                            });
                        player.addTo(map);
                    }
                    else if (c[1] === "quit") {
                        players[c[2]].remove();
                        players[c[2]] = null;
                    }
                    else if (c[1] === "move") {
                        var pos = c[3].split(",");
                        players[c[2]].setLatLng([parseInt(pos[0]), parseInt(pos[1])]);
                    }
                }
            }
        };

        socket.open();


        $.getJSON("/regions/Overworld.json",
            function(data) {
                console.log(data);
                $.each(data,
                    function(key, value) {
                        L.polygon(value, { color: 'red' }).addTo(map);
                    });
            });
    </script>
</body>
</html>